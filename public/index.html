<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Rooms</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5;
        }

        #app-container {
            width: 100%;
            height: 100%;
        }

        /* Lobby Styles */
        #lobby {
            padding: 40px;
            max-width: 600px;
            margin: 40px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #room-list .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #room-list .list-group-item:hover {
            background-color: #f8f9fa;
        }

        /* Chat Room Styles */
        #chat-room {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        #chat-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        #sidebar {
            flex: 0 0 200px;
            padding: 15px;
            background-color: #f7f7f7;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        #messages-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        #messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #e9ebee;
        }

        .message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message .user-info {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .message.my-message {
            background-color: #0084ff;
            color: white;
            margin-left: auto;
        }

        .message.other-message {
            background-color: #f1f0f0;
            color: #333;
            margin-right: auto;
        }

        #form {
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #f7f7f7;
        }

        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 65px; /* Position above the input form */
            left: 15px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            width: 280px;
        }
        .emoji {
            cursor: pointer;
            font-size: 24px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- Lobby View -->
        <div id="lobby">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0">Chat Rooms</h2>
                <button id="change-name-btn-lobby" class="btn btn-sm btn-outline-secondary">Change Name</button>
            </div>
            <p class="text-center text-muted mb-4">Welcome, <strong id="lobby-username"></strong></p>
            <div class="mb-3">
                <button id="create-room-btn" class="btn btn-primary btn-block">Create New Room</button>
            </div>
            <hr>
            <h4>Available Rooms</h4>
            <p class="text-muted small">ÁÑ°‰∫∫‰ΩøÁî®ÁöÑËÅäÂ§©ÂÆ§Â∞áÊñº24Â∞èÊôÇÂæåËá™ÂãïÁßªÈô§„ÄÇ</p>
            <ul id="room-list" class="list-group"></ul>
        </div>

        <!-- Chat Room View -->
        <div id="chat-room" class="d-none">
            <div id="chat-container">
                <div id="sidebar">
                    <h5 id="room-name-title"></h5>
                    <button id="leave-room-btn" class="btn btn-sm btn-danger mb-2">Leave Room</button>
                    <hr>
                    <b>Online Users</b>
                    <ul id="user-list" class="list-unstyled"></ul>
                </div>
                <div id="messages-area">
                    <div id="messages"></div>
                    <form id="form" action="" class="input-group position-relative">
                        <div class="input-group-prepend">
                            <button type="button" id="emoji-btn" class="btn btn-outline-secondary">üòÄ</button>
                        </div>
                        <div id="emoji-picker" class="emoji-picker"></div>
                        <input id="input" class="form-control" autocomplete="off" placeholder="Type your message or paste an image...">
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
        const socket = io();

        // Views
        const lobbyView = document.getElementById('lobby');
        const chatRoomView = document.getElementById('chat-room');

        // Lobby elements
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomList = document.getElementById('room-list');
        const changeNameBtnLobby = document.getElementById('change-name-btn-lobby');
        const lobbyUsername = document.getElementById('lobby-username');

        // Chat Room elements
        const roomNameTitle = document.getElementById('room-name-title');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const userList = document.getElementById('user-list');
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');

        // App state
        let userName = null;
        let myUser = null;

        // --- Cookie Functions ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // --- Initial Setup ---
        async function init() {
            userName = getCookie("username");
            if (!userName) {
                const value = await swal("Please enter your name:", {
                    content: "input",
                });
                userName = value || `Anonymous${Math.floor(Math.random() * 1000)}`;
                setCookie("username", userName, 30);
            }
            lobbyUsername.textContent = userName;
            setupEmojiPicker();
            showLobby();
        }

        // --- View Switching ---
        function showLobby() {
            lobbyView.classList.remove('d-none');
            chatRoomView.classList.add('d-none');
        }

        function showChatRoom() {
            lobbyView.classList.add('d-none');
            chatRoomView.classList.remove('d-none');
        }

        // --- UI Update Functions ---
        function updateRoomList(rooms) {
            roomList.innerHTML = '';
            if (Object.keys(rooms).length === 0) {
                roomList.innerHTML = '<li class="list-group-item">No rooms available. Create one!</li>';
                return;
            }
            for (const roomName in rooms) {
                const room = rooms[roomName];
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';

                let icon = '';
                if (room.isPublic === false) {
                    icon = ' <span class="text-muted">üîí</span>';
                }
                li.innerHTML = `${room.name}${icon} <span class="badge badge-primary badge-pill">${room.userCount}</span>`;

                li.addEventListener('click', () => {
                    if (room.isPublic === true) {
                        socket.emit('join room', { roomName: room.name, userName });
                    } else {
                        swal("This room is private. Enter password:", {
                            content: "input",
                            attributes: { type: "password" },
                        }).then(password => {
                            if (password !== null) { // Allow empty password string but not cancellation
                                socket.emit('join room', { roomName: room.name, password, userName });
                            }
                        });
                    }
                });
                roomList.appendChild(li);
            }
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = `${user.emoji} ${user.name}`;
                if (user.id === socket.id) {
                    li.innerHTML += ' (You)';
                    myUser = user;
                }
                userList.appendChild(li);
            });
        }

        function addMessage(message) {
            const item = document.createElement('div');
            item.classList.add('message');

            const isMyMessage = myUser && message.user.id === myUser.id;
            item.classList.add(isMyMessage ? 'my-message' : 'other-message');

            const userInfo = isMyMessage ? 'You' : `${message.user.emoji} ${message.user.name}`;
            item.innerHTML = `<div class="user-info">${userInfo}</div><div>${message.content}</div>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        // --- Feature Setup ---
        function setupEmojiPicker() {
            const emojis = ['üòÄ', 'üòÅ', 'üòÇ', 'ü§£', 'üòÉ', 'üòÑ', 'üòÖ', 'üòÜ', 'üòâ', 'üòä', 'üòã', 'üòé', 'üòç', 'üòò', 'üòó', 'üòô', 'üòö', 'üôÇ', 'ü§ó', 'ü§î', 'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üòØ', 'üò™', 'üò´', 'üò¥', 'üòå', 'üòõ', 'üòú', 'üòù', 'ü§§', 'üòí', 'üòì', 'üòî', 'üòï', 'üôÉ', 'ü§ë', 'üò≤', '‚òπÔ∏è', 'üôÅ', 'üòñ', 'üòû', 'üòü', 'üò§', 'üò¢', 'üò≠', 'üò¶', 'üòß', 'üò®', 'üò©', 'ü§Ø', 'üò¨', 'üò∞', 'üò±', 'üò≥', 'ü§™', 'üòµ', 'üò°', 'üò†', 'ü§¨', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'üòá', 'ü§†', 'ü§°', 'ü§•', 'ü§´', 'ü§≠', 'üßê', 'ü§ì', 'üòà', 'üëø', 'üëç', 'üëé', '‚ù§Ô∏è', 'üíî', 'üéâ', '‚ú®', 'üî•', 'üíØ'];
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji';
                span.textContent = emoji;
                span.addEventListener('click', () => {
                    input.value += emoji;
                    emojiPicker.style.display = 'none';
                    input.focus();
                });
                emojiPicker.appendChild(span);
            });
        }

        // --- Socket Event Listeners ---
        socket.on('room list', updateRoomList);

        socket.on('error message', (message) => {
            swal("Error", message, "error");
        });

        socket.on('join success', ({ roomName, users, history }) => {
            showChatRoom();
            roomNameTitle.textContent = roomName;
            updateUserList(users);
            messages.innerHTML = '';
            history.forEach(addMessage);
        });

        socket.on('user list', updateUserList);
        socket.on('chat message', addMessage);

        // --- UI Event Handlers ---
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (e.target !== emojiBtn && !emojiPicker.contains(e.target)) {
                emojiPicker.style.display = 'none';
            }
        });

        input.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imgHTML = `<a href="${event.target.result}" target="_blank"><img src="${event.target.result}" style="max-width: 250px; border-radius: 5px;" /></a>`;
                        socket.emit('chat message', imgHTML);
                    };
                    reader.readAsDataURL(file);
                    return;
                }
            }
        });

        changeNameBtnLobby.addEventListener('click', async () => {
            const newName = await swal("Enter your new name:", {
                content: "input",
                value: userName,
            });
            if (newName && newName.trim() !== '') {
                userName = newName.trim();
                setCookie("username", userName, 30);
                lobbyUsername.textContent = userName;
                swal("Success", "Your name has been updated!", "success");
            }
        });

        createRoomBtn.addEventListener('click', async () => {
            const roomName = await swal("Enter new room name:", {
                content: "input",
            });
            if (!roomName) return;
            const password = await swal("Enter password (optional, leave blank for public):", {
                content: "input",
                attributes: { type: "password" },
            });
            socket.emit('create room', { roomName, password, userName });
        });

        leaveRoomBtn.addEventListener('click', () => {
            window.location.reload();
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageContent = input.value.trim();
            if (messageContent) {
                socket.emit('chat message', messageContent);
                input.value = '';
            }
        });

        // --- Run --- 
        init();

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Rooms</title>
    <link rel="icon" href="/images/chat.png" type="image/x-icon" />
    <script src="/vendor/marked.min.js"></script>

    <link rel="stylesheet" href="/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="/vendor/lightbox.min.css">
    <link rel="stylesheet" href="/vendor/sweetalert2.min.css">

  
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5;
        }

        #app-container {
            width: 100%;
            height: 100%;
        }

        /* Lobby Styles */
        #lobby {
            padding: 40px;
            max-width: 600px;
            margin: 40px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #room-list .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #room-list .list-group-item:hover {
            background-color: #f8f9fa;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        /* Chat Room Styles */
        #chat-room {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        #chat-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        #sidebar {
            flex: 0 0 200px;
            padding: 15px;
            background-color: #f7f7f7;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        #messages-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        #messages {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #e9ebee;
        }

        .message {
            padding: 8px 12px;
            margin-bottom: 7px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            /* white-space: pre-line; */
            /* æ”¯æŒæ›è¡Œ */
        }

        .message .user-info {
            font-weight: bold;
            font-size: 0.9em;
            /* margin-bottom: 2px; */
        }

        .message.my-message {
            background-color: #9ccefd;
            color: #333;
            margin-left: auto;
        }

        .message.other-message {
            background-color: #f1f0f0;
            color: #333;
            margin-right: auto;
        }

        .message-content {
            /* white-space: pre-wrap; */
            /* margin-top: 10px; */
            margin-bottom: 0px;
            padding: 0;
        }

        p {
            margin: 0;
            padding: 0;
        }

        #form {
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #f7f7f7;
        }

        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 65px;
            /* Position above the input form */
            left: 15px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 280px;
        }

        .emoji {
            cursor: pointer;
            font-size: 24px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- Lobby View -->
        <div id="lobby" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0"><a href=""> Chat Rooms</a></h2>
                <button id="change-name-btn-lobby" class="btn btn-sm btn-outline-secondary">Change Name</button>
            </div>
            <p class="text-center text-muted mb-4">Welcome, <strong id="lobby-username"></strong></p>
            <div id="identity-section" class="mb-3">
                <small class="text-muted">Your User ID:</small>
                <div class="input-group">
                    <input type="text" id="user-uuid-display" class="form-control form-control-sm" readonly>
                    <div class="input-group-append">
                        <button id="copy-uuid-btn" class="btn btn-sm btn-outline-secondary">Copy</button>
                    </div>
                </div>
                <button id="restore-identity-btn" class="btn btn-sm btn-link pl-0">Have an ID? Restore it here.</button>
            </div>
            <div class="mb-3">
                <button id="create-room-btn" class="btn btn-primary btn-block">Create New Room</button>
            </div>
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>Available Rooms</h4>
                <small class="text-muted">Online: <span id="online-users-count">0</span></small>
            </div>
            <p class="text-muted ">ğŸŒ å¤§å»³æ¸…å–®ä¸Šé¡¯ç¤º ğŸ‘€ çŸ¥é“é€£çµ&å»ºç«‹è€…å¯ä»¥çœ‹çš„åˆ° ğŸ”’ éœ€è¦å¯†ç¢¼</p>

            <ul id="room-list" class="list-group"></ul>
        </div>

        <!-- Chat Room View -->
        <div id="chat-room" class="d-none">
            <div id="chat-container">
                <div id="sidebar">
                    <h5 id="room-name-title"></h5>
                    <button id="leave-room-btn" class="btn btn-sm btn-danger mb-2">Leave Room</button>
                    <!-- <button id="change-emoji-btn" class="btn btn-sm btn-info mb-2">Change Emoji</button> -->
                    <hr>
                    <b>Online Users</b>
                    <ul id="user-list" class="list-unstyled"></ul>
                </div>
                <div id="messages-area">
                    <div id="messages"></div>
                    <form id="form" action="" class="input-group position-relative">
                        <div class="input-group-prepend">
                            <button type="button" id="emoji-btn" class="btn btn-outline-secondary">ğŸ˜€</button>
                        </div>
                        <div id="emoji-picker" class="emoji-picker"></div>
                        <!-- <input id="input" class="form-control" autocomplete="off" placeholder="Type your message or paste an image..."> -->
                        <textarea id="input" class="form-control" rows="2" autocomplete="off"
                            placeholder="Type your message or paste an image..."></textarea>
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/vendor/jquery.min.js"></script>
    <script src="/vendor/lightbox.min.js"></script>
    <script src="/vendor/sweetalert2.all.min.js"></script>
    <script>
        lightbox.option({
            'fadeDuration': 300,
            'resizeDuration': 300
        })
    </script>
    <script>
        const socket = io();

        // Views
        const lobbyView = document.getElementById('lobby');
        const chatRoomView = document.getElementById('chat-room');

        // Lobby elements
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomList = document.getElementById('room-list');
        const changeNameBtnLobby = document.getElementById('change-name-btn-lobby');
        const lobbyUsername = document.getElementById('lobby-username');
        const userUuidDisplay = document.getElementById('user-uuid-display');
        const copyUuidBtn = document.getElementById('copy-uuid-btn');
        const restoreIdentityBtn = document.getElementById('restore-identity-btn');

        // Chat Room elements
        const roomNameTitle = document.getElementById('room-name-title');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const userList = document.getElementById('user-list');
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');

        // App state
        let userName = null;
        let userUUID = null;
        let myUser = null;
        let currentRoomUUID = null;
        let isAutoRejoining = false;

        // --- UUID Generator ---
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Initial Setup ---
        async function init() {
            // Get or create user UUID
            userUUID = localStorage.getItem("userUUID");
            if (!userUUID) {
                userUUID = uuidv4();
                localStorage.setItem("userUUID", userUUID);
            }
            userUuidDisplay.value = userUUID;

            // Get or create username
            userName = localStorage.getItem("username");
            if (!userName) {
                const { value: nameValue } = await Swal.fire({
                    title: 'Enter your name',
                    input: 'text',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!'
                        }
                    }
                });
                userName = nameValue;
                localStorage.setItem("username", userName);
            }
            lobbyUsername.textContent = userName;

            setupEmojiPicker();

            // Auto-rejoin logic
            const roomUUIDFromHash = window.location.hash.substring(1);
            if (roomUUIDFromHash) {
                isAutoRejoining = true;
                socket.emit('join room', { roomUUID: roomUUIDFromHash, userName, userUUID });
            } else {
                showLobby();
            }
        }

        // --- View Switching ---
        function showLobby() {
            lobbyView.classList.remove('d-none');
            chatRoomView.classList.add('d-none');
        }

        function showChatRoom() {
            lobbyView.classList.add('d-none');
            chatRoomView.classList.remove('d-none');
        }

        // --- UI Update Functions ---
        function updateRoomList(rooms) {
            roomList.innerHTML = '';
            const visibleRooms = rooms.filter(room => room.isListed || room.creator === userUUID);

            if (visibleRooms.length === 0) {
                roomList.innerHTML = '<li class="list-group-item">No rooms available. Create one!</li>';
                return;
            }

            visibleRooms.forEach(room => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.dataset.uuid = room.uuid;

                let icons = '';
                if (room.isListed) {
                    icons += 'ğŸŒ';
                }
                else {
                    icons += 'ğŸ‘€';
                }

                if (room.isPublic === false) {
                    icons += 'ğŸ”’';
                }

                if (icons != '') {
                    icons = `<span title="listed Room">${icons}</span>`;
                }



                li.innerHTML = `${room.name}${icons} <span class="badge badge-primary badge-pill">${room.userCount}</span>`;

                li.addEventListener('click', () => {
                    if (room.isPublic === true) {
                        socket.emit('join room', { roomUUID: room.uuid, userName, userUUID });
                    } else {
                        Swal.fire({
                            title: 'This room is private',
                            input: 'password',
                            inputPlaceholder: 'Enter password',
                            showCancelButton: true
                        }).then((result) => {
                            if (result.isConfirmed) {
                                socket.emit('join room', { roomUUID: room.uuid, password: result.value, userName, userUUID });
                            }
                        });
                    }
                });
                roomList.appendChild(li);
            });
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = `${user.emoji} ${user.name}`;
                if (user.uuid === userUUID) {
                    li.innerHTML += ' (You)';
                    myUser = user;
                }
                userList.appendChild(li);
            });
        }

        function addMessage(message) {
            const item = document.createElement('div');
            item.classList.add('message');

            const isMyMessage = myUser && message.user.uuid === myUser.uuid;
            item.classList.add(isMyMessage ? 'my-message' : 'other-message');

            const userInfo = isMyMessage ? '' : `${message.user.emoji} ${message.user.name}`;
            let renderedContent = marked.parse(message.content.trim()); // æ¸²æŸ“ Markdown
            //renderedContent = renderedContent.trim().replaceAll('\r\n', "<br>").replaceAll('\n', "<br>")
            //const renderedContent = message.content;

            item.innerHTML = `<div class="user-info">${userInfo}</div><div class="message-content">${renderedContent}</div>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        // --- Feature Setup ---
        function setupEmojiPicker() {
            const emojis = ['ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´', 'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²', 'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©', 'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ’”', 'ğŸ‰', 'âœ¨', 'ğŸ”¥', 'ğŸ’¯'];
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji';
                span.textContent = emoji;
                span.addEventListener('click', () => {
                    input.value += emoji;
                    emojiPicker.style.display = 'none';
                    input.focus();
                });
                emojiPicker.appendChild(span);
            });
        }

        // --- Socket Event Listeners ---
        socket.on('room list', updateRoomList);

        socket.on('error message', (message) => {
            if (isAutoRejoining && message === 'Incorrect password.') {
                const roomUUIDFromHash = window.location.hash.substring(1);
                Swal.fire({
                    title: 'This room is private',
                    input: 'password',
                    inputPlaceholder: 'Enter password',
                    showCancelButton: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        socket.emit('join room', { roomUUID: roomUUIDFromHash, password: result.value, userName, userUUID });
                    }
                });
            } else {
                Swal.fire('Error', message, 'error');
            }
            isAutoRejoining = false; // Reset flag after handling
        });

        socket.on('join success', ({ roomUUID, roomName, users, history, creator }) => {
            isAutoRejoining = false; // Reset flag on success
            currentRoomUUID = roomUUID;
            window.location.hash = roomUUID;
            showChatRoom();
            roomNameTitle.textContent = roomName;
            updateUserList(users);
            messages.innerHTML = '';
            history.forEach(addMessage);

            // Show/hide close room button
            const closeRoomBtnContainer = document.getElementById('sidebar');
            let closeRoomBtn = document.getElementById('close-room-btn');
            if (creator === userUUID) {
                if (!closeRoomBtn) {
                    closeRoomBtn = document.createElement('button');
                    closeRoomBtn.id = 'close-room-btn';
                    closeRoomBtn.className = 'btn btn-sm btn-warning mt-2';
                    closeRoomBtn.textContent = 'Close Room';
                    closeRoomBtn.addEventListener('click', () => {
                        Swal.fire({
                            title: "Are you sure?",
                            text: "This will permanently close the room for everyone.",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonText: 'Yes, close it!',
                            cancelButtonText: 'No, cancel!',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.isConfirmed) {
                                socket.emit('close room', { roomUUID: currentRoomUUID, userUUID });
                            }
                        });
                    });
                    leaveRoomBtn.after(closeRoomBtn);
                }
                closeRoomBtn.style.display = 'block';
            } else if (closeRoomBtn) {
                closeRoomBtn.style.display = 'none';
            }
        });

        socket.on('room closed', (message) => {
            Swal.fire("Room Closed", message, "info").then(() => {
                window.location.hash = '';
                window.location.reload();
            });
        });

        socket.on('user list', updateUserList);
        socket.on('chat message', addMessage);

        socket.on('online users count', (count) => {
            document.getElementById('online-users-count').textContent = count;
        });

        // --- UI Event Handlers ---
        copyUuidBtn.addEventListener('click', () => {
            userUuidDisplay.select();
            document.execCommand('copy');
            Swal.fire('Copied!', 'Your User ID has been copied to the clipboard.', 'success');
        });

        restoreIdentityBtn.addEventListener('click', async () => {
            const { value: newUUID } = await Swal.fire({
                title: 'Restore Identity',
                input: 'text',
                inputPlaceholder: 'Paste your User ID here'
            });
            if (newUUID && newUUID.trim() !== '') {
                localStorage.setItem("userUUID", newUUID.trim());
                window.location.reload();
            }
        });

        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (e.target !== emojiBtn && !emojiPicker.contains(e.target)) {
                emojiPicker.style.display = 'none';
            }
        });

        input.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const imgHTML = `<a href="${event.target.result}" data-lightbox="chat-image"><img src="${event.target.result}" style="max-width: 250px; border-radius: 5px;" /></a>`;
                        socket.emit('chat message', imgHTML);
                    };
                    reader.readAsDataURL(file);
                    return;
                }
            }
        });

        changeNameBtnLobby.addEventListener('click', async () => {
            const { value: newName } = await Swal.fire({
                title: 'Enter your new name',
                input: 'text',
                inputValue: userName
            });
            if (newName && newName.trim() !== '') {
                userName = newName.trim();
                localStorage.setItem("username", userName);
                lobbyUsername.textContent = userName;
                Swal.fire('Success', 'Your name has been updated!', 'success');
            }
        });

        createRoomBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Create New Room',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="Room Name" style="width: 80%; margin: 5px;">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="Password (optional)" type="password" style="width: 80%; margin: 5px;">' +
                    '<div class="swal2-content" style="margin: 5px;"><label><input type="checkbox" id="swal-input3"> é¡¯ç¤ºæ–¼æ¸…å–®</label></div>' +
                    'èŠå¤©å®¤å°‡æ–¼ä»¥ä¸‹æ™‚é–“<b>`é–’ç½®`</b>å¾Œè‡ªå‹•ç§»é™¤!<br>' +
                    '<select id="swal-input4" class="swal2-input" style="width: 80%; margin: 5px;">' +
                    '<option value="30">Auto-close after 30 Minutes</option>' +
                    '<option value="60">Auto-close after 1 Hour</option>' +
                    '<option value="360">Auto-close after 6 Hours</option>' +
                    '<option value="1440" selected>Auto-close after 24 Hours</option>' +
                    '<option value="1440" selected>Auto-close after 1 Day</option>' +
                    '<option value="10080">Auto-close after 7 Days</option>' +
                    '<option value="43200">Auto-close after 30 Days</option>' +
                    '</select>',


                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value,
                        document.getElementById('swal-input3').checked,
                        document.getElementById('swal-input4').value
                    ]
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [roomName, password, isListed, autoCloseMinutes] = result.value;
                    if (roomName) {
                        socket.emit('create room', { roomName, password, isListed, autoCloseMinutes, userName, userUUID });
                    }
                }
            });
        });

        leaveRoomBtn.addEventListener('click', () => {
            window.location.hash = '';
            window.location.reload();
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageContent = input.value.trim();
            if (messageContent) {
                socket.emit('chat message', messageContent);
                input.value = '';
            }
        });

        // ç›£è½ textarea çš„æŒ‰éµäº‹ä»¶
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // é˜²æ­¢æ›è¡Œ
                form.dispatchEvent(new Event('submit')); // æ¨¡æ“¬æäº¤è¡¨å–®
            }
        });

        // --- Run --- 
        init();

    </script>